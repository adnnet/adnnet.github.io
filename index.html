<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>答题小程序</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
        
        .quiz-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        h1, h2 {
            margin-top: 0;
        }
        
        .question {
            font-size: 18px;
            margin: 20px 0;
            text-align: left;
        }
        
        .options {
            text-align: left;
            margin: 20px 0;
        }
        
        .option {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .option.selected {
            background: rgba(76, 175, 80, 0.5);
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .result-message {
            font-size: 24px;
            color: #FFD700;
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        textarea, input, select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            margin: 15px 0;
            resize: vertical;
            box-sizing: border-box;
        }
        
        input[type="text"] {
            min-height: 40px;
        }
        
        textarea {
            min-height: 100px;
        }
        
        .survey-question {
            text-align: left;
            margin: 20px 0;
        }
        
        .qr-code {
            margin: 20px auto;
            padding: 15px;
            background: white;
            width: fit-content;
            border-radius: 10px;
        }
        
        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            border-radius: 5px;
        }
        
        .question-form {
            text-align: left;
            margin: 20px 0;
        }
        
        .question-form label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .option-input input[type="text"] {
            flex: 1;
            margin: 0 10px;
        }
        
        .option-input input[type="checkbox"] {
            width: auto;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .question-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .question-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .question-item:last-child {
            border-bottom: none;
        }
        
        .question-type {
            font-size: 14px;
            color: #FFD700;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- 开始页面 -->
        <div id="start-screen" class="screen active">
            <h1>答题小程序</h1>
            <button class="btn" onclick="startQuiz()">开始答题</button>
            <div style="margin-top: 20px; font-size: 14px;">
                <a href="#" onclick="showAdminLogin()" style="color: #FFD700; text-decoration: none;">管理员登录</a>
            </div>
        </div>
        
        <!-- 管理员登录页面 -->
        <div id="admin-login-screen" class="screen">
            <h2>管理员登录</h2>
            <div style="text-align: left; margin: 20px 0;">
                <label>请输入管理员密码：</label>
                <input type="password" id="admin-password" placeholder="密码" style="width: 100%; padding: 10px; margin: 10px 0;" autocomplete="new-password">
            </div>
            <button class="btn" onclick="checkAdminPassword()">登录</button>
            <button class="btn btn-secondary" onclick="showStartScreen()" style="margin-top: 10px;">返回</button>
        </div>
        
        <!-- 二维码扫码页面 -->
        <div id="qrcode-screen" class="screen">
            <h1>欢迎参加云内控合规日答题活动</h1>
            <div class="qr-code">
                <div class="qr-placeholder">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" alt="二维码" width="200" height="200" id="qr-code-img">
                </div>
                <p>请扫描二维码开始答题</p>
                <p id="deploy-note" style="font-size: 12px; color: #FFD700; margin-top: 10px; display: none;">
                    提示：请将此页面部署到Web服务器以生成有效二维码
                </p>
            </div>
            <button class="btn" onclick="proceedToQuiz()">开始答题</button>
        </div>
        
        <!-- 答题页面 -->
        <div id="quiz-screen" class="screen">
            <h2>答题环节</h2>
            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p>第 <span id="current-question">1</span>/<span id="total-questions">3</span> 题</p>
            </div>
            <div class="question" id="question-text"></div>
            <div class="options" id="options-container"></div>
            <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>下一题</button>
        </div>
        
        <!-- 调研页面 -->
        <div id="survey-screen" class="screen">
            <h2>调研问卷</h2>
            <div class="survey-question">
                <p>您对云内控的工作有哪些建议或意见？</p>
                <textarea id="survey-input" placeholder="请输入您的宝贵意见..." autocomplete="off"></textarea>
            </div>
            <button class="btn" onclick="submitSurvey()">提交</button>
        </div>
        
        <!-- 结果页面 -->
        <div id="result-screen" class="screen">
            <h2>答题完成</h2>
            <div class="result-message" id="result-message"></div>
            <button class="btn" onclick="restartQuiz()">重新开始</button>
        </div>
        
        <!-- 管理员主界面 -->
        <div id="admin-main-screen" class="screen">
            <h2>管理员功能</h2>
            <button class="btn" onclick="showScreen('qrcode-screen')">开始答题</button>
            <button class="btn" onclick="showAdminPanel()" style="background-color: #2196F3;">题目管理</button>
            <button class="btn" onclick="logoutAdmin()" style="background-color: #f44336;">退出登录</button>
        </div>
        
        <!-- 管理页面 -->
        <div id="admin-screen" class="screen">
            <h2>题目管理</h2>
            <div class="question-form">
                <label>题目类型：</label>
                <select id="question-type" onchange="updateAnswerInputs()">
                    <option value="single">单选题</option>
                    <option value="multiple">多选题</option>
                    <option value="truefalse">判断题</option>
                </select>
                
                <label>题目内容：</label>
                <textarea id="question-content" placeholder="请输入题目内容"></textarea>
                
                <div id="options-section">
                    <label>选项：</label>
                    <div id="options-inputs">
                        <!-- 选项将通过JavaScript动态生成 -->
                    </div>
                    <button class="btn" onclick="addOption()">添加选项</button>
                </div>
                
                <div id="truefalse-section" class="hidden">
                    <label>正确答案：</label>
                    <select id="truefalse-answer">
                        <option value="true">正确</option>
                        <option value="false">错误</option>
                    </select>
                </div>
                
                <button class="btn" onclick="saveQuestion()">保存题目</button>
            </div>
            
            <div class="question-list">
                <h3>题目列表</h3>
                <div id="questions-list">
                    <!-- 题目列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="question-list">
                <h3>用户建议</h3>
                <div id="suggestions-list">
                    <!-- 建议列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <button class="btn" onclick="showScreen('qrcode-screen')">开始答题</button>
            <button class="btn" onclick="exportSuggestions()">导出所有建议</button>
            <button class="btn" onclick="showAdminMainScreen()">返回管理员主界面</button>
        </div>
    </div>

    <script>
        // 题库 - 支持单选、多选、判断题
        let questionBank = [];
        
        // 游戏状态
        let gameState = {
            currentQuestionIndex: 0,
            selectedQuestions: [],
            userAnswers: [],
            score: 0
        };
        
        // 页面加载时初始化
        window.onload = function() {
            loadQuestions();
            updateQuestionsList();
            // 生成包含当前页面URL的二维码
            generateQRCode();
            // 清除可能的自动填充内容
            clearAutoFill();
        };
                    
        // 清除可能的自动填充内容
        function clearAutoFill() {
            const adminPassword = document.getElementById('admin-password');
            const surveyInput = document.getElementById('survey-input');
                        
            if (adminPassword) {
                adminPassword.value = '';
            }
                        
            if (surveyInput) {
                surveyInput.value = '';
            }
        }
        
        // 生成二维码
        function generateQRCode() {
            // 获取当前页面的完整URL
            let currentURL = window.location.href;
            
            // 如果是本地文件路径，则提示用户需要部署到服务器
            if (currentURL.startsWith('file://')) {
                // 对于本地文件，生成一个提示信息
                currentURL = 'adnnet.github.io/index.html'; // 默认提示链接
                document.getElementById('qr-code-img').alt = "请将此页面部署到Web服务器以生成有效二维码";
                document.getElementById('deploy-note').style.display = 'block';
            }
            
            // 更新二维码图片的src属性
            const qrCodeImg = document.getElementById('qr-code-img');
            if (qrCodeImg) {
                qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentURL)}`;
            }
        }
        
        // 从localStorage加载题目
        function loadQuestions() {
            const savedQuestions = localStorage.getItem('quizQuestions');
            if (savedQuestions) {
                questionBank = JSON.parse(savedQuestions);
            } else {
                // 如果没有保存的题目，则初始化默认题目
                initializeDefaultQuestions();
            }
        }
        
        // 初始化默认题目
        function initializeDefaultQuestions() {
            questionBank = [
                {
                    type: 'single',
                    question: '云智能集团的流程管理，谁是第一责任人？',
                    options: [
                        { text: '销售管理' },
                        { text: '云内控' },
                        { text: '流程业务负责人' },
                        { text: '销售运营' }
                    ],
                    answer: 2
                },
                {
                    type: 'truefalse',
                    question: '业务正常开展过程中的常规损耗，例如数据中心资产处置损失，需计入资损事件。',
                    answer: 'false'
                },
                {
                    type: 'single',
                    question: '云智能集团的资损事件管理中，谁是第一责任人？',
                    options: [
                        { text: '云内控' },
                        { text: '各事业部总裁及财务一号位' },
                        { text: '各事业部风险管理岗' },
                        { text: 'ESU' }
                    ],
                    answer: 1
                },
                {
                    type: 'single',
                    question: '若您感知到资损事件，需在最晚不迟于事件发现后几个工作日内上报云内控或云应急组织？',
                    options: [
                        { text: '3' },
                        { text: '4' },
                        { text: '5' },
                        { text: '6' }
                    ],
                    answer: 2
                },
                {
                    type: 'single',
                    question: '云智能业财风控平台推送的计量计费稽核工单，处理SLA为几个工作日？',
                    options: [
                        { text: '4' },
                        { text: '5' },
                        { text: '6' },
                        { text: '7' }
                    ],
                    answer: 1
                },
                {
                    type: 'truefalse',
                    question: '云内控推送的风险任务工单处理率会影响内控对事业部的评价。',
                    answer: 'true'
                },
                {
                    type: 'truefalse',
                    question: '资损事件如果上报不及时，会影响内控对事业部的评价。',
                    answer: 'true'
                },
                {
                    type: 'single',
                    question: '以下哪项属于内控季度评价的考核维度？',
                    options: [
                        { text: '资损管理有效性' },
                        { text: '风险整改有效性' },
                        { text: '风险预警处理有效性' },
                        { text: '以上都是' }
                    ],
                    answer: 3
                }
            ];
            // 保存到localStorage
            saveQuestions();
        }
        
        // 保存题目到localStorage
        function saveQuestions() {
            localStorage.setItem('quizQuestions', JSON.stringify(questionBank));
        }
        
        // 开始答题
        function startQuiz() {
            // 检查是否已登录为管理员
            if (sessionStorage.getItem('isAdmin') === 'true') {
                // 管理员直接进入答题环节，跳过二维码页面
                proceedToQuiz();
            } else {
                // 普通用户直接进入答题环节，跳过二维码页面
                proceedToQuiz();
            }
        }
        
        // 显示管理员主界面
        function showAdminMainScreen() {
            showScreen('admin-main-screen');
        }
        
        // 管理员退出登录
        function logoutAdmin() {
            sessionStorage.removeItem('isAdmin');
            showStartScreen();
        }
        
        // 继续进入答题环节
        function proceedToQuiz() {
            loadQuestions();
            // 现在题库中已经有默认题目了，不会为空
            
            // 随机选择3道题目
            gameState.selectedQuestions = getRandomQuestions(questionBank, Math.min(3, questionBank.length));
            gameState.userAnswers = new Array(gameState.selectedQuestions.length).fill(null);
            gameState.currentQuestionIndex = 0;
            gameState.score = 0;
            
            // 显示答题页面
            showScreen('quiz-screen');
            loadQuestion();
        }
        
        // 从题库中随机选择指定数量的题目
        function getRandomQuestions(questions, count) {
            // 创建题库副本
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            // 返回前count个题目
            return shuffled.slice(0, count);
        }
        
        // 显示指定屏幕
        function showScreen(screenId) {
            // 隐藏所有屏幕
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            // 显示指定屏幕
            document.getElementById(screenId).classList.add('active');
        }
        
        // 加载当前题目
        function loadQuestion() {
            const question = gameState.selectedQuestions[gameState.currentQuestionIndex];
            // 显示题型和题目内容
            let typeText = '';
            if (question.type === 'single') typeText = '【单选题】';
            else if (question.type === 'multiple') typeText = '【多选题】';
            else if (question.type === 'truefalse') typeText = '【判断题】';
            
            document.getElementById('question-text').innerHTML = `<span style="color:#4CAF50;font-weight:bold;">${typeText}</span><br>${question.question}`;
            
            // 更新进度条
            const progressPercent = ((gameState.currentQuestionIndex) / gameState.selectedQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('current-question').textContent = gameState.currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = gameState.selectedQuestions.length;
            
            // 清除之前的选项
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            // 根据题目类型显示选项
            if (question.type === 'truefalse') {
                // 判断题选项
                const trueOption = document.createElement('div');
                trueOption.className = 'option';
                trueOption.textContent = 'A. 正确';
                trueOption.onclick = () => selectOption('true', trueOption);
                
                const falseOption = document.createElement('div');
                falseOption.className = 'option';
                falseOption.textContent = 'B. 错误';
                falseOption.onclick = () => selectOption('false', falseOption);
                
                // 如果之前已选择此选项，则高亮显示
                if (gameState.userAnswers[gameState.currentQuestionIndex] === 'true') {
                    trueOption.classList.add('selected');
                } else if (gameState.userAnswers[gameState.currentQuestionIndex] === 'false') {
                    falseOption.classList.add('selected');
                }
                
                optionsContainer.appendChild(trueOption);
                optionsContainer.appendChild(falseOption);
            } else {
                // 单选题和多选题
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.textContent = String.fromCharCode(65 + index) + '. ' + option.text;
                    
                    if (question.type === 'single') {
                        // 单选题
                        optionElement.onclick = () => selectOption(index, optionElement);
                    } else {
                        // 多选题
                        optionElement.onclick = () => toggleMultipleOption(index, optionElement);
                    }
                    
                    // 如果之前已选择此选项，则高亮显示
                    if (question.type === 'single' && gameState.userAnswers[gameState.currentQuestionIndex] === index) {
                        optionElement.classList.add('selected');
                    } else if (question.type === 'multiple' && Array.isArray(gameState.userAnswers[gameState.currentQuestionIndex]) && 
                               gameState.userAnswers[gameState.currentQuestionIndex].includes(index)) {
                        optionElement.classList.add('selected');
                    }
                    
                    optionsContainer.appendChild(optionElement);
                });
            }
            
            // 更新下一题按钮状态
            updateNextButton();
        }
        
        // 选择单选题选项
        function selectOption(optionIndex, element) {
            // 清除之前的选择
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 标记当前选择
            element.classList.add('selected');
            gameState.userAnswers[gameState.currentQuestionIndex] = optionIndex;
            
            // 更新下一题按钮状态
            updateNextButton();
        }
        
        // 切换多选题选项
        function toggleMultipleOption(optionIndex, element) {
            // 初始化答案数组
            if (!Array.isArray(gameState.userAnswers[gameState.currentQuestionIndex])) {
                gameState.userAnswers[gameState.currentQuestionIndex] = [];
            }
            
            const answers = gameState.userAnswers[gameState.currentQuestionIndex];
            const index = answers.indexOf(optionIndex);
            
            if (index === -1) {
                // 添加选项
                element.classList.add('selected');
                answers.push(optionIndex);
            } else {
                // 移除选项
                element.classList.remove('selected');
                answers.splice(index, 1);
            }
            
            // 更新下一题按钮状态
            updateNextButton();
        }
        
        // 更新下一题按钮状态
        function updateNextButton() {
            const nextBtn = document.getElementById('next-btn');
            const currentAnswer = gameState.userAnswers[gameState.currentQuestionIndex];
            
            // 根据题目类型检查是否有答案
            if (gameState.selectedQuestions[gameState.currentQuestionIndex].type === 'multiple') {
                nextBtn.disabled = !Array.isArray(currentAnswer) || currentAnswer.length === 0;
            } else {
                nextBtn.disabled = currentAnswer === null;
            }
        }
        
        // 下一题
        function nextQuestion() {
            // 如果是最后一题，检查答案并进入调研
            if (gameState.currentQuestionIndex === gameState.selectedQuestions.length - 1) {
                checkAnswers();
                showScreen('survey-screen');
            } else {
                // 进入下一题
                gameState.currentQuestionIndex++;
                loadQuestion();
            }
        }
        
        // 检查答案
        function checkAnswers() {
            gameState.score = 0;
            for (let i = 0; i < gameState.selectedQuestions.length; i++) {
                const question = gameState.selectedQuestions[i];
                const userAnswer = gameState.userAnswers[i];
                
                if (question.type === 'single') {
                    // 单选题
                    if (userAnswer === question.answer) {
                        gameState.score++;
                    }
                } else if (question.type === 'multiple') {
                    // 多选题
                    if (Array.isArray(userAnswer) && Array.isArray(question.answer)) {
                        // 检查答案是否完全匹配
                        if (userAnswer.length === question.answer.length && 
                            userAnswer.every(val => question.answer.includes(val)) &&
                            question.answer.every(val => userAnswer.includes(val))) {
                            gameState.score++;
                        }
                    }
                } else if (question.type === 'truefalse') {
                    // 判断题
                    if (userAnswer === question.answer) {
                        gameState.score++;
                    }
                }
            }
        }
        
        // 提交调研
        function submitSurvey() {
            // 获取调研内容
            const surveyInput = document.getElementById('survey-input');
            const surveyText = surveyInput.value.trim();
            
            // 验证字符数
            if (surveyText.length < 5) {
                alert('请输入至少5个字的建议或意见！');
                surveyInput.focus();
                return;
            }
            
            // 保存建议到localStorage
            saveSurveySuggestion(surveyText);
            
            // 显示结果页面
            showScreen('result-screen');
            
            // 根据答题结果设置消息
            const resultMessage = document.getElementById('result-message');
            if (gameState.score === gameState.selectedQuestions.length) {
                // 定义奖品列表和对应的权重
                const prizes = [
                    { name: '笔记本支架', weight: 30 },
                    { name: '大鼠标垫', weight: 32 },
                    { name: '运动毛巾', weight: 32 },
                    { name: '弹力带', weight: 40 },
                    { name: '野餐垫', weight: 12 },
                    { name: '手机支架', weight: 40 },
                    { name: '内控定制杜邦袋', weight: 160 },
                    { name: '趣味打工人亚克力摆件', weight: 200 }
                ];
                // 根据权重随机选择一个奖品
                const randomPrize = weightedRandom(prizes);
                resultMessage.textContent = `恭喜你回答100%正确，获得${randomPrize}~`;
            } else {
                resultMessage.textContent = `您答对了${gameState.score}题，感谢参与！`;
            }
        }
        
        // 保存建议到localStorage
        function saveSurveySuggestion(suggestion) {
            // 获取当前时间
            const now = new Date();
            const timestamp = now.toLocaleString();
            
            // 创建建议对象
            const suggestionObj = {
                text: suggestion,
                timestamp: timestamp
            };
            
            // 从localStorage获取现有的建议
            let suggestions = [];
            const savedSuggestions = localStorage.getItem('quizSuggestions');
            if (savedSuggestions) {
                try {
                    suggestions = JSON.parse(savedSuggestions);
                } catch (e) {
                    console.error('解析历史建议时出错:', e);
                }
            }
            
            // 添加新建议
            suggestions.push(suggestionObj);
            
            // 保存到localStorage
            try {
                localStorage.setItem('quizSuggestions', JSON.stringify(suggestions));
            } catch (e) {
                console.error('保存建议时出错:', e);
            }
        }
        
        // 重新开始
        function restartQuiz() {
            showScreen('start-screen');
            // 清除可能的输入
            clearInputs();
        }
        
        // 加权随机选择函数
        function weightedRandom(items) {
            // 计算总权重
            let totalWeight = 0;
            for (let i = 0; i < items.length; i++) {
                totalWeight += items[i].weight;
            }
            
            // 生成一个随机数
            let random = Math.random() * totalWeight;
            
            // 根据权重选择项目
            for (let i = 0; i < items.length; i++) {
                if (random < items[i].weight) {
                    return items[i].name;
                }
                random -= items[i].weight;
            }
            
            // 如果没有匹配到（理论上不应该发生），返回第一个项目
            return items[0].name;
        }
        
        // 显示管理员登录页面
        function showAdminLogin() {
            showScreen('admin-login-screen');
            // 清除密码输入框
            const adminPassword = document.getElementById('admin-password');
            if (adminPassword) {
                adminPassword.value = '';
            }
        }
        
        // 检查管理员密码
        function checkAdminPassword() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            
            if (password === 'adn17') { // 默认密码，实际使用中应加密存储
                // 标记用户为管理员并显示管理员主界面
                sessionStorage.setItem('isAdmin', 'true');
                showAdminMainScreen();
            } else {
                alert('密码错误，请重新输入！');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // 显示管理面板
        function showAdminPanel() {
            showScreen('admin-screen');
            updateAnswerInputs();
            updateQuestionsList();
            updateSuggestionsList();
        }
        
        // 更新建议列表
        function updateSuggestionsList() {
            const suggestionsList = document.getElementById('suggestions-list');
            suggestionsList.innerHTML = '';
            
            // 从localStorage获取建议
            let suggestions = [];
            const savedSuggestions = localStorage.getItem('quizSuggestions');
            if (savedSuggestions) {
                try {
                    suggestions = JSON.parse(savedSuggestions);
                } catch (e) {
                    console.error('解析建议时出错:', e);
                    suggestionsList.innerHTML = '<p>加载建议时出错</p>';
                    return;
                }
            }
            
            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<p>暂无用户建议</p>';
                return;
            }
            
            // 反向排序，最新的建议显示在前面
            suggestions.reverse();
            
            // 显示建议
            suggestions.forEach((suggestion, index) => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'question-item';
                suggestionDiv.innerHTML = `
                    <div><strong>建议 ${suggestions.length - index}:</strong> ${suggestion.text}</div>
                    <div class="question-type">时间: ${suggestion.timestamp}</div>
                `;
                suggestionsList.appendChild(suggestionDiv);
            });
        }
        
        // 导出建议为CSV文件
        function exportSuggestions() {
            // 从localStorage获取建议
            let suggestions = [];
            const savedSuggestions = localStorage.getItem('quizSuggestions');
            if (savedSuggestions) {
                try {
                    suggestions = JSON.parse(savedSuggestions);
                } catch (e) {
                    console.error('解析建议时出错:', e);
                    alert('导出建议时出错，请查看控制台');
                    return;
                }
            }
            
            if (suggestions.length === 0) {
                alert('暂无用户建议可导出');
                return;
            }
            
            // 构建CSV内容
            let csvContent = '\uFEFF"序号","建议内容","提交时间"\n'; // 添加BOM以支持中文
            
            suggestions.forEach((suggestion, index) => {
                // 转义引号并包裹字段
                const escapedText = suggestion.text.replace(/"/g, '""');
                const escapedTimestamp = suggestion.timestamp.replace(/"/g, '""');
                
                csvContent += `"${index + 1}","${escapedText}","${escapedTimestamp}"\n`;
            });
            
            // 创建下载链接
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // 设置文件名
            const now = new Date();
            const filename = `用户建议_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // 触发下载
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 显示开始页面
        function showStartScreen() {
            // 清除管理员标记
            sessionStorage.removeItem('isAdmin');
            showScreen('start-screen');
            // 清除可能的输入
            clearInputs();
        }
        
        // 清除可能的输入
        function clearInputs() {
            const adminPassword = document.getElementById('admin-password');
            const surveyInput = document.getElementById('survey-input');
            
            if (adminPassword) {
                adminPassword.value = '';
            }
            
            if (surveyInput) {
                surveyInput.value = '';
            }
        }
        
        // 更新答案输入区域
        function updateAnswerInputs() {
            const questionType = document.getElementById('question-type').value;
            const optionsSection = document.getElementById('options-section');
            const truefalseSection = document.getElementById('truefalse-section');
            
            if (questionType === 'truefalse') {
                optionsSection.classList.add('hidden');
                truefalseSection.classList.remove('hidden');
            } else {
                optionsSection.classList.remove('hidden');
                truefalseSection.classList.add('hidden');
                
                // 初始化选项输入
                const optionsInputs = document.getElementById('options-inputs');
                optionsInputs.innerHTML = '';
                
                // 添加默认选项
                for (let i = 0; i < 4; i++) {
                    addOption();
                }
            }
        }
        
        // 添加选项
        function addOption() {
            const optionsInputs = document.getElementById('options-inputs');
            const optionIndex = optionsInputs.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-input';
            optionDiv.innerHTML = `
                <input type="checkbox" id="option-correct-${optionIndex}" title="正确答案">
                <input type="text" id="option-text-${optionIndex}" placeholder="选项内容" style="flex:1; margin:0 10px;">
                <button class="btn btn-danger" onclick="removeOption(this)">删除</button>
            `;
            
            optionsInputs.appendChild(optionDiv);
        }
        
        // 删除选项
        function removeOption(button) {
            button.parentElement.remove();
        }
        
        // 保存题目
        function saveQuestion() {
            const questionType = document.getElementById('question-type').value;
            const questionContent = document.getElementById('question-content').value.trim();
            
            if (!questionContent) {
                alert('请输入题目内容！');
                return;
            }
            
            let question = {
                type: questionType,
                question: questionContent
            };
            
            if (questionType === 'truefalse') {
                // 判断题
                question.answer = document.getElementById('truefalse-answer').value;
            } else {
                // 单选题或多选题
                const options = [];
                const correctAnswers = [];
                const optionsInputs = document.getElementById('options-inputs');
                
                for (let i = 0; i < optionsInputs.children.length; i++) {
                    const textInput = document.getElementById(`option-text-${i}`);
                    const correctCheckbox = document.getElementById(`option-correct-${i}`);
                    
                    if (textInput && textInput.value.trim()) {
                        options.push({
                            text: textInput.value.trim()
                        });
                        
                        if (correctCheckbox && correctCheckbox.checked) {
                            correctAnswers.push(i);
                        }
                    }
                }
                
                if (options.length === 0) {
                    alert('请至少添加一个选项！');
                    return;
                }
                
                if (correctAnswers.length === 0) {
                    alert('请至少选择一个正确答案！');
                    return;
                }
                
                question.options = options;
                question.answer = questionType === 'single' ? correctAnswers[0] : correctAnswers;
            }
            
            // 添加到题库
            questionBank.push(question);
            
            // 保存到localStorage
            saveQuestions();
            
            // 更新题目列表
            updateQuestionsList();
            
            // 清空表单
            document.getElementById('question-content').value = '';
            if (questionType !== 'truefalse') {
                document.getElementById('options-inputs').innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    addOption();
                }
            }
            
            alert('题目保存成功！');
        }
        
        // 更新题目列表
        function updateQuestionsList() {
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = '';
            
            if (questionBank.length === 0) {
                questionsList.innerHTML = '<p>暂无题目</p>';
                return;
            }
            
            questionBank.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                let typeText = '';
                if (q.type === 'single') typeText = '单选题';
                else if (q.type === 'multiple') typeText = '多选题';
                else if (q.type === 'truefalse') typeText = '判断题';
                
                questionDiv.innerHTML = `
                    <div><strong>${q.question}</strong></div>
                    <div class="question-type">${typeText}</div>
                `;
                
                questionsList.appendChild(questionDiv);
            });
        }
    </script>
</body>
</html>
